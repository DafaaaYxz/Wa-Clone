<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - <%= targetUser.name %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-vibe { background-color: #f8fafc; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }
        .bubble-me { background-color: #10b981; color: white; border-radius: 15px 15px 0 15px; }
        .bubble-them { background-color: white; color: #1e293b; border-radius: 15px 15px 15px 0; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="flex flex-col h-screen bg-vibe font-sans">
    <!-- Header -->
    <div class="bg-slate-800 p-4 flex items-center text-white shadow-lg z-10">
        <a href="/home" class="mr-4 text-xl font-bold text-emerald-400">‚Üê</a>
        <a href="/profile/<%= targetUser.phone %>" class="flex items-center">
            <img src="<%= targetUser.photo %>" class="w-10 h-10 rounded-full mr-3 border-2 border-emerald-500 object-cover">
            <div>
                <h2 class="font-bold text-sm leading-none"><%= targetUser.name %></h2>
                <small class="<%= status === 'online' ? 'text-emerald-400' : 'text-slate-400' %> text-[10px] font-bold uppercase tracking-widest">
                    ‚óè <%= status %>
                </small>
            </div>
        </a>
    </div>

    <!-- Messages Area -->
    <div id="chatBox" class="flex-1 overflow-y-auto p-4 flex flex-col-reverse space-y-reverse space-y-4">
        <% messages.forEach(msg => { 
            let isMe = (msg.sender === myPhone);
        %>
            <div class="flex <%= isMe ? 'justify-end' : 'justify-start' %>">
                <div class="<%= isMe ? 'bubble-me' : 'bubble-them' %> p-3 max-w-[85%] shadow-sm relative group">
                    <% if(msg.photo) { %>
                        <img src="<%= msg.photo %>" class="rounded-lg mb-2 max-w-full border border-black/5">
                    <% } %>
                    <p class="text-sm md:text-base pr-8 break-words leading-relaxed">
                        <%= msg.text %>
                    </p>
                    <span class="text-[9px] <%= isMe ? 'text-emerald-100' : 'text-slate-400' %> absolute bottom-1 right-2 font-mono">
                        <%= msg.time %>
                    </span>
                </div>
            </div>
        <% }) %>
    </div>

    <!-- Input Area -->
    <div class="bg-white p-4 border-t border-slate-200 flex items-center gap-3">
        <label class="cursor-pointer hover:bg-slate-100 p-2 rounded-full transition">
            <span class="text-xl">üì∑</span> 
            <input type="file" id="fileInp" class="hidden" accept="image/*">
        </label>
        <input type="text" id="msgInp" placeholder="Tulis pesan..." class="flex-1 p-3 rounded-2xl bg-slate-100 border-none focus:ring-2 focus:ring-emerald-500 text-sm">
        <button onclick="send()" id="btnSend" class="bg-emerald-600 text-white p-3 rounded-2xl w-12 h-12 flex items-center justify-center shadow-lg hover:bg-emerald-700 active:scale-90 transition">
            <span class="text-xl">‚û§</span>
        </button>
    </div>

    <script>
        async function send() {
            const btn = document.getElementById('btnSend');
            const text = document.getElementById('msgInp').value;
            const file = document.getElementById('fileInp').files[0];
            let photoData = null;

            if(!text && !file) return;
            btn.disabled = true;

            const processSend = async (photo) => {
                await fetch('/send-message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        targetPhone: '<%= targetUser.phone %>',
                        text: text,
                        photoData: photo
                    })
                });
                window.location.reload();
            };

            if(file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => processSend(reader.result);
            } else {
                await processSend(null);
            }
        }

        // Auto Refresh pesan baru tiap 8 detik
        setInterval(() => { location.reload(); }, 8000);
    </script>
</body>
</html>

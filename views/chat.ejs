<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - <%= targetUser.name %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-chat { background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .bubble-me { background-color: #dcf8c6; border-radius: 8px 0 8px 8px; }
        .bubble-them { background-color: #ffffff; border-radius: 0 8px 8px 8px; }
    </style>
</head>
<body class="flex flex-col h-screen bg-chat">
    <!-- Header -->
    <div class="bg-[#075e54] p-3 flex items-center text-white shadow-md">
        <a href="/home" class="mr-3 text-xl">‚Üê</a>
        <img src="<%= targetUser.photo %>" class="w-10 h-10 rounded-full mr-3 border">
        <div class="flex-1">
            <h2 class="font-bold leading-none"><%= targetUser.name %></h2>
            <small class="text-gray-200"><%= status === 'online' ? 'Online' : 'Offline' %></small>
        </div>
    </div>

    <!-- Messages Area -->
    <div id="chatBox" class="flex-1 overflow-y-auto p-4 flex flex-col-reverse">
        <% messages.forEach(msgStr => { 
            let msg = JSON.parse(msgStr);
            let isMe = msg.sender === myPhone;
        %>
            <div class="mb-3 flex <%= isMe ? 'justify-end' : 'justify-start' %>">
                <div class="<%= isMe ? 'bubble-me' : 'bubble-them' %> p-2 max-w-[80%] shadow-sm relative">
                    <% if(msg.photo) { %>
                        <img src="<%= msg.photo %>" class="rounded mb-1 max-w-full">
                    <% } %>
                    <p class="text-gray-800 text-sm md:text-base pr-10" style="word-wrap: break-word;">
                        <%= msg.text %>
                    </p>
                    <span class="text-[10px] text-gray-500 absolute bottom-1 right-2"><%= msg.time %></span>
                </div>
            </div>
        <% }) %>
    </div>

    <!-- Input Area -->
    <div class="bg-[#f0f0f0] p-3 flex items-center gap-2">
        <label class="cursor-pointer bg-gray-300 p-2 rounded-full">
            üì∑ <input type="file" id="fileInp" class="hidden" accept="image/*">
        </label>
        <input type="text" id="msgInp" placeholder="Ketik pesan" class="flex-1 p-2 rounded-full border focus:outline-none">
        <button onclick="send()" class="bg-[#00a884] text-white p-2 rounded-full w-10 h-10 flex items-center justify-center shadow">
            ‚û§
        </button>
    </div>

    <script>
        // Scroll ke bawah saat baru buka
        window.onload = () => { document.getElementById('chatBox').scrollTop = 0; }

        async function send() {
            const text = document.getElementById('msgInp').value;
            const file = document.getElementById('fileInp').files[0];
            let photoData = null;

            if(!text && !file) return;

            if(file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    photoData = reader.result;
                    await processSend(text, photoData);
                };
            } else {
                await processSend(text, null);
            }
        }

        async function processSend(text, photo) {
            await fetch('/send-message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    targetPhone: '<%= targetUser.phone %>',
                    text: text,
                    photoData: photo
                })
            });
            window.location.reload();
        }

        // Auto Refresh pesan baru
        setInterval(() => {
            // Kita bisa pakai fetch ringan di sini, tapi reload adalah cara termudah di Vercel
            location.reload();
        }, 7000);
    </script>
</body>
</html>
